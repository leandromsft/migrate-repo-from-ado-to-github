name: inventory-report

on:
  workflow_dispatch:
    inputs:
      ado_org_name:
        description: 'Azure DevOps Organization Name'
        required: true
        default: 'my-ado-org'

permissions:
  contents: read
  models: read

jobs:
  run-inventory-report:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¦ Install gh-ado2gh extension"
        run: |
          gh extension install github/gh-ado2gh
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
      
      - name: "ğŸ—‚ï¸ Generate inventory report"
        run: |
          gh ado2gh inventory-report --ado-org "${{ github.event.inputs.ado_org_name }}"
        env:
          ADO_PAT: ${{ secrets.ADO_PAT }}

      - name: "ğŸ‘€ View report content"
        run: ls -R
      
      - name: "ğŸ“Š Prepare CSV data for AI analysis"
        id: prepare_csv_data
        run: |
          echo "Preparando dados dos CSVs para anÃ¡lise AI..."
          
          # Criar variÃ¡vel de ambiente com os dados dos CSVs
          echo "CSV_DATA_CONTENT<<EOF" >> $GITHUB_ENV
          echo "## DADOS COMPLETOS DOS ARQUIVOS CSV PARA ANÃLISE:" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          
          echo "### ğŸ“Š ORGS.CSV:" >> $GITHUB_ENV
          if [ -f "orgs.csv" ]; then
            cat orgs.csv >> $GITHUB_ENV
          else
            echo "âŒ Arquivo orgs.csv nÃ£o encontrado" >> $GITHUB_ENV
          fi
          echo "" >> $GITHUB_ENV
          echo "---" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          
          echo "### ğŸ‘¥ TEAM-PROJECTS.CSV:" >> $GITHUB_ENV
          if [ -f "team-projects.csv" ]; then
            cat team-projects.csv >> $GITHUB_ENV
          else
            echo "âŒ Arquivo team-projects.csv nÃ£o encontrado" >> $GITHUB_ENV
          fi
          echo "" >> $GITHUB_ENV
          echo "---" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          
          echo "### ğŸ“ REPOS.CSV:" >> $GITHUB_ENV
          if [ -f "repos.csv" ]; then
            cat repos.csv >> $GITHUB_ENV
          else
            echo "âŒ Arquivo repos.csv nÃ£o encontrado" >> $GITHUB_ENV
          fi
          echo "" >> $GITHUB_ENV
          echo "---" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          
          echo "### ğŸ”§ PIPELINES.CSV:" >> $GITHUB_ENV
          if [ -f "pipelines.csv" ]; then
            cat pipelines.csv >> $GITHUB_ENV
          else
            echo "âŒ Arquivo pipelines.csv nÃ£o encontrado" >> $GITHUB_ENV
          fi
          echo "EOF" >> $GITHUB_ENV
          
          echo "âœ… Dados preparados com sucesso!"
          echo "ğŸ“ Arquivos CSV encontrados:"
          ls -la *.csv 2>/dev/null || echo "âš ï¸ Nenhum arquivo CSV encontrado"

      - name: "ğŸ“Š Analyze CSV files with AI"
        id: csv_analysis
        uses: actions/ai-inference@v1
        with:
          prompt: |
            Analise os seguintes arquivos CSV gerados pelo inventÃ¡rio do Azure DevOps e forneÃ§a um resumo executivo detalhado:

            ${{ env.CSV_DATA_CONTENT }}

            ## Arquivos para AnÃ¡lise:

            1. **orgs.csv** - InformaÃ§Ãµes da organizaÃ§Ã£o Azure DevOps
            2. **team-projects.csv** - Detalhes dos projetos de equipe
            3. **repos.csv** - InventÃ¡rio completo dos repositÃ³rios
            4. **pipelines.csv** - Listagem de pipelines de CI/CD

            ## Estrutura da AnÃ¡lise Solicitada:

            ### 1. **VisÃ£o Geral da OrganizaÃ§Ã£o**
            - Nome da organizaÃ§Ã£o e proprietÃ¡rio
            - Quantidade total de projetos de equipe
            - Quantidade total de repositÃ³rios
            - Quantidade total de pipelines
            - Quantidade total de pull requests
            - Status de permissÃµes administrativas

            ### 2. **AnÃ¡lise de Projetos de Equipe**
            - Projetos mais ativos (por quantidade de repositÃ³rios e pipelines)
            - Projetos com maior nÃºmero de PRs
            - Projetos inativos ou subutilizados
            - DistribuiÃ§Ã£o de recursos por projeto

            ### 3. **AnÃ¡lise de RepositÃ³rios**
            - RepositÃ³rios por tamanho (maiores repositÃ³rios)
            - RepositÃ³rios por atividade recente (Ãºltimo push)
            - RepositÃ³rios com mais pipelines associados
            - RepositÃ³rios com mais PRs
            - RepositÃ³rios inativos (sem commits no Ãºltimo ano)
            - Contribuidores mais ativos

            ### 4. **AnÃ¡lise de Pipelines**
            - DistribuiÃ§Ã£o de pipelines por projeto
            - Projetos com maior automaÃ§Ã£o (mais pipelines)
            - IdentificaÃ§Ã£o de padrÃµes de nomenclatura
            - Pipelines Ã³rfÃ£os ou nÃ£o utilizados

            ### 5. **RecomendaÃ§Ãµes para MigraÃ§Ã£o**
            - Projetos prioritÃ¡rios para migraÃ§Ã£o (baseado em atividade)
            - RepositÃ³rios que podem ser arquivados
            - ConsolidaÃ§Ã£o de projetos similares
            - EstratÃ©gia de migraÃ§Ã£o por fases
            - IdentificaÃ§Ã£o de dependÃªncias entre repositÃ³rios

            ### 6. **MÃ©tricas de SaÃºde do DevOps**
            - Taxa de automaÃ§Ã£o (pipelines vs repositÃ³rios)
            - Engajamento da equipe (PRs e commits)
            - DistribuiÃ§Ã£o de tamanhos de repositÃ³rio
            - FrequÃªncia de atualizaÃ§Ãµes

            ### 7. **Pontos de AtenÃ§Ã£o**
            - RepositÃ³rios muito grandes que podem ter problemas na migraÃ§Ã£o
            - Projetos sem atividade recente
            - Falta de pipelines em repositÃ³rios ativos
            - Problemas potenciais de permissÃ£o

            ## Formato de SaÃ­da Esperado:

            ForneÃ§a um relatÃ³rio estruturado em markdown com:
            - Resumo executivo (2-3 parÃ¡grafos)
            - Dados estatÃ­sticos principais em tabelas
            - GrÃ¡ficos textuais quando aplicÃ¡vel
            - Lista de recomendaÃ§Ãµes priorizadas
            - Cronograma sugerido para migraÃ§Ã£o
            - Checklist de validaÃ§Ã£o pÃ³s-migraÃ§Ã£o
            - EstratÃ©gias de rollback se necessÃ¡rio

            ## InstruÃ§Ãµes Adicionais:

            - Use os dados exatos dos CSVs
            - Calcule percentuais e mÃ©dias quando relevante  
            - Identifique outliers e padrÃµes interessantes
            - Priorize insights acionÃ¡veis
            - Mantenha o foco na preparaÃ§Ã£o para migraÃ§Ã£o para GitHub

            Analise especificamente estes dados e forneÃ§a insights prÃ¡ticos para a equipe responsÃ¡vel pela migraÃ§Ã£o.

          model: openai/gpt-4o
          max-tokens: 8000

      - name: "ğŸ“ Create analysis report"
        run: |
          echo "# RelatÃ³rio de AnÃ¡lise do InventÃ¡rio Azure DevOps" > analysis-report.md
          echo "" >> analysis-report.md
          echo "**OrganizaÃ§Ã£o:** ${{ github.event.inputs.ado_org_name }}" >> analysis-report.md
          echo "**Data da AnÃ¡lise:** $(date)" >> analysis-report.md
          echo "" >> analysis-report.md
          echo "${{ steps.csv_analysis.outputs.response }}" >> analysis-report.md

      - name: "ğŸ“¦ Upload logs artifact"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-logs
          path: "*.log"

      - name: "ğŸ“¦ Upload inventory reports"
        uses: actions/upload-artifact@v4
        with:
          name: inventory-report
          path: "*.csv"

      - name: "ğŸ“¦ Upload analysis reports"
        uses: actions/upload-artifact@v4
        with:
          name: analysis-reports
          path: analysis-report.md

      - name: "ğŸ“‹ Create job summary"
        run: |
          echo "## ğŸ¯ Resumo da ExecuÃ§Ã£o - InventÃ¡rio Azure DevOps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š InformaÃ§Ãµes Gerais" >> $GITHUB_STEP_SUMMARY
          echo "- **OrganizaÃ§Ã£o:** ${{ github.event.inputs.ado_org_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Data/Hora:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Executor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### âœ… Status das Etapas" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… InventÃ¡rio gerado para organizaÃ§Ã£o: ${{ github.event.inputs.ado_org_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AnÃ¡lise AI dos dados concluÃ­da" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Plano de migraÃ§Ã£o gerado" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… RelatÃ³rios exportados como artefatos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“ Artefatos DisponÃ­veis" >> $GITHUB_STEP_SUMMARY
          echo "| Artefato | DescriÃ§Ã£o |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š inventory-report | Arquivos CSV com dados do inventÃ¡rio |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ analysis-reports | RelatÃ³rios de anÃ¡lise e plano de migraÃ§Ã£o |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“‹ report-logs | Logs detalhados de execuÃ§Ã£o |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“‹ PrÃ³ximos Passos" >> $GITHUB_STEP_SUMMARY
          echo "1. **Baixar artefatos**: Acesse a aba 'Summary' desta execuÃ§Ã£o para baixar os relatÃ³rios" >> $GITHUB_STEP_SUMMARY
          echo "2. **Revisar anÃ¡lise**: Examine o arquivo \`analysis-report.md\` para insights detalhados" >> $GITHUB_STEP_SUMMARY
          echo "3. **Validar plano**: Revise o arquivo \`migration-plan.md\` antes de executar a migraÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "4. **Executar migraÃ§Ã£o**: Use os comandos sugeridos no plano para iniciar a migraÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*RelatÃ³rio gerado automaticamente pelo workflow de inventÃ¡rio Azure DevOps*" >> $GITHUB_STEP_SUMMARY
          
          # TambÃ©m mostra no console para debug
          echo "ğŸ“‹ Job summary criado com sucesso!"
          echo "ğŸ”— Acesse a aba 'Summary' para visualizar o relatÃ³rio completo."
