name: migrate-repo

on:
  issue_comment:
    types: [created, edited]

jobs:
  run-migrate-repo:
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.issue.labels.*.name, 'repo') && contains(github.event.comment.body, 'approved') }}
    steps:
      - name: "ðŸ”Ž Parse form fields"
        id: parse
        uses: zentered/issue-forms-body-parser@v2.2.0

      - name: "ðŸ“ Show parsed data"
        run: echo ${{ toJSON(steps.parse.outputs.data) }}

      - name: "ðŸ§® Create variables"
        id: set-variables
        uses: actions/github-script@v7
        with:
          script: |
            function slugify(text)
            {
                  return text
                  .toString()                // Cast to string (optional)
                  .normalize('NFKD')         // The normalize() using NFKD method returns the Unicode Normalization Form of a given string.
                  .toLowerCase()             // Convert the string to lowercase letters
                  .trim()                    // Remove whitespace from both sides of a string (optional)
                  .replace(/\s+/g, '')       // Replace spaces with empty string
                  .replace(/[^\w\-]+/g, '')  // Remove all non-word chars
                  .replace(/\-\-+/g, '-');   // Replace multiple - with single
            }

            var orgName = '${{ fromJSON(steps.parse.outputs.data).azure-dev-ops-organization.text }}';
            core.setOutput('ADO_ORG_NAME', orgName);

            var tpName = '${{ fromJSON(steps.parse.outputs.data).azure-dev-ops-team-project.text }}';
            core.setOutput('ADO_TP_NAME', tpName);
            
            var adoRepoName = '${{ fromJSON(steps.parse.outputs.data).azure-dev-ops-repository-name.text }}';
            core.setOutput('ADO_REPO_NAME', adoRepoName);

            core.setOutput('GH_ORG_NAME', '${{ github.repository_owner }}');

            var slugRepoName = slugify('${{ fromJSON(steps.parse.outputs.data).azure-dev-ops-repository-name.text }}');
            core.setOutput('GH_REPO_NAME', slugRepoName);

      - name: "ðŸ“¢ Show Variables"
        run: |
          echo "Azure DevOps Info"
          echo "âœ… ADO Org Name = ${{ steps.set-variables.outputs.ADO_ORG_NAME }}"
          echo "âœ… ADO Team Project Name = ${{ steps.set-variables.outputs.ADO_TP_NAME }}"
          echo "âœ… ADO Repo Name = ${{ steps.set-variables.outputs.ADO_REPO_NAME }}"
          
          echo "GitHub Info"
          echo "âœ… GH Org Name = ${{ steps.set-variables.outputs.GH_ORG_NAME }}"
          echo "âœ… GH Repo Name = ${{ steps.set-variables.outputs.GH_REPO_NAME }}"
      
      - name: "ðŸ“¦ Install gh-ado2gh extension"
        run: |
          gh extension install github/gh-ado2gh
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
      
      - name: "ðŸšš Migrate repo"
        id: migrate-repo
        run: |
          gh ado2gh migrate-repo \
            --ado-org "${{ steps.set-variables.outputs.ADO_ORG_NAME }}" \
            --ado-team-project "${{ steps.set-variables.outputs.ADO_TP_NAME }}" \
            --ado-repo "${{ steps.set-variables.outputs.ADO_REPO_NAME }}" \
            --github-org "${{ steps.set-variables.outputs.GH_ORG_NAME }}" \
            --github-repo "${{ steps.set-variables.outputs.GH_REPO_NAME }}" 2>&1| tee "$GITHUB_WORKSPACE/migration_exec.log"
          
          echo "migration_exec_log_file=$GITHUB_WORKSPACE/migration_exec.log" >> $GITHUB_OUTPUT
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          ADO_PAT: ${{ secrets.ADO_PAT }}
      
      - name: "ðŸ“¥ Download logs"
        id: download-logs
        run: |
          migrationLog=$(gh ado2gh download-logs --github-org "${{ steps.set-variables.outputs.GH_ORG_NAME }}" --github-repo "${{ steps.set-variables.outputs.GH_REPO_NAME }}")
          echo "$migrationLog"

          filename=$(echo "$migrationLog" | grep -oP "\[INFO\] Downloaded (.+) log to (.+)\." | awk '{print $NF}' | sed 's/\.$//')
          echo "Arquivo de log detectado: $filename"

          if [ -z "$filename" ]; then
            echo "[ERRO] Nenhum arquivo de log detectado. O output 'logfile' serÃ¡ vazio."
          else 
            echo "Log Content: $filename"
            cat $filename
          fi
          
          echo "logfile=$filename" >> $GITHUB_OUTPUT
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          ADO_PAT: ${{ secrets.ADO_PAT }}
      
      - name: "ðŸ“¦ Upload logs artifact"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: migration-logs
          path: "*.log"

      - name: "ðŸ’¬ Comment Issue"
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const fs = require('fs');
            const path = `${{ steps.migrate-repo.outputs.migration_exec_log_file }}`;
            const ghRepoUrl = `https://github.com/${{ steps.set-variables.outputs.GH_ORG_NAME }}/${{ steps.set-variables.outputs.GH_REPO_NAME }}`;

            core.info(`Lendo arquivo de log da migraÃ§Ã£o em: ${path}`);
            core.info(`URL do repositÃ³rio GitHub: ${ghRepoUrl}`);

            let migrationExecLog = '';
            
            try {
              migrationExecLog = fs.readFileSync(path, 'utf8');
              core.info(`Log carregado`);
            } catch (e) {
              core.error(`Erro ao ler o arquivo de log: ${path}`);
            }

            let statusMsg = '';
            if (migrationExecLog.includes('[ERROR]')) {
              statusMsg = `âŒ Migration failed.\nFor more details, check the logs in the workflow execution (artifacts section).`;
            } else if (migrationExecLog.includes('[WARNING]')) {
              statusMsg = `âš ï¸ Review migration.\nFor more details, check the logs in the workflow execution (artifacts section).\n\n**New GitHub Repository:** ${ghRepoUrl}`;
            } else {
              statusMsg = `âœ… Migration successful\n\n**New GitHub Repository:** ${ghRepoUrl}`;
            }
            
            console.info(`Status da migraÃ§Ã£o: ${statusMsg}`);
            const body = `${statusMsg}\n\nLog de execuÃ§Ã£o:\n\n${migrationExecLog}`;
            
            const issueNumber = context.issue.number;

            if (issueNumber) {
              core.info(`Creating issue comment: ${issueNumber}`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: String(body)
              });
            } else {
              core.info('No associated issue to comment on.');
            }
      
      - name: "ðŸ·ï¸ Add topic to migrated repo"
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            try {
              core.info('Adding topic "migrate-from-ado" to the migrated repository');
              
              await github.rest.repos.replaceAllTopics({
                owner: '${{ steps.set-variables.outputs.GH_ORG_NAME }}',
                repo: '${{ steps.set-variables.outputs.GH_REPO_NAME }}',
                names: ['migrate-from-ado']
              });
              
              core.info('âœ… Topic "migrate-from-ado" added successfully');
            } catch (error) {
              core.warning(`Failed to add topic: ${error.message}`);
            }
      
      - name: "ðŸ”’ Disable ADO repo"
        run: |
          gh ado2gh disable-ado-repo --ado-org "${{ steps.set-variables.outputs.ADO_ORG_NAME }}" --ado-team-project "${{ steps.set-variables.outputs.ADO_TP_NAME }}" --ado-repo "${{ steps.set-variables.outputs.ADO_REPO_NAME }}"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          ADO_PAT: ${{ secrets.ADO_PAT }}

      - name: "ðŸ“Š Migration Summary"
        if: always()
        run: |
          echo "## Migration Summary" >> $GITHUB_STEP_SUMMARY
          if grep -q '\[ERROR\]' ${{ steps.migrate-repo.outputs.migration_exec_log_file }}; then
            echo "âŒ Migration failed.\nFor more details, check the logs in the workflow execution (artifacts section)." >> $GITHUB_STEP_SUMMARY
          elif grep -q '\[WARNING\]' ${{ steps.migrate-repo.outputs.migration_exec_log_file }}; then
            echo "âš ï¸ Review migration.\nFor more details, check the logs in the workflow execution (artifacts section)." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Migration successful" >> $GITHUB_STEP_SUMMARY
          fi
          
          # SÃ³ adiciona o link do repositÃ³rio se nÃ£o houver erro
          if ! grep -q '\[ERROR\]' ${{ steps.migrate-repo.outputs.migration_exec_log_file }}; then
            echo " " >> $GITHUB_STEP_SUMMARY
            echo "New GitHub Repository" >> $GITHUB_STEP_SUMMARY
            echo "[${{ steps.set-variables.outputs.GH_REPO_NAME }}](https://github.com/${{ steps.set-variables.outputs.GH_ORG_NAME }}/${{ steps.set-variables.outputs.GH_REPO_NAME }})" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo " " >> $GITHUB_STEP_SUMMARY
          echo "Triggering Issue" >> $GITHUB_STEP_SUMMARY
          echo "[Issue #${{ github.event.issue.number }}](https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }})" >> $GITHUB_STEP_SUMMARY
          